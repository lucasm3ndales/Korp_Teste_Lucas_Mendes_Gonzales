@if (isOpen) {
  <p-dialog
    header="Nova Nota Fiscal"
    [modal]="true"
    [(visible)]="isOpen"
    [closable]="false"
    [style]="{ width: '40rem' }"
  >
    <form [formGroup]="invoiceNoteForm" (ngSubmit)="saveInvoiceNote()">

      <div class="flex flex-col w-full mb-4 gap-2">
        <p class="font-semibold text-lg text-tertiary">Adicionar Produto</p>
        <div class="flex items-center gap-2">

          <div class="flex-grow">
            @if (availableSelectItems$ | async; as selectItems) {
              @if (selectItems.length > 0) {
                <app-single-select
                  label="Produto"
                  placeholder="Selecione um produto"
                  size="small"
                  [items]="selectItems"
                  [ngModel]="selectedProductId"
                  (ngModelChange)="selectedProductId = $event"
                  [ngModelOptions]="{ standalone: true }"
                  [required]="false"
                />
              } @else {
                <div class="p-message p-message-warn mt-2">
                  <span class="p-message-text">Nenhum produto disponível.</span>
                </div>
              }
            }
          </div>

          <div class="w-1/4">
            <p-button
              icon="pi pi-plus"
              label="Adicionar"
              styleClass="bg-accent text-secondary hover:bg-secondary hover:text-white border-accent w-full"
              type="button"
              (click)="addItem()"
              [disabled]="!selectedProductId || tempQuantity < 1"
            />
          </div>
        </div>
      </div>

      <h3 class="text-lg font-bold mb-2">Itens da Nota ({{ itemsFormArray.length }})</h3>
      <div formArrayName="items" class="p-fluid max-h-60 overflow-y-auto p-2 gap-2 flex flex-col">

        @for (itemGroup of itemsFormArray.controls; track $index) {
          <div
            [formGroupName]="$index"
            class="flex items-center justify-between px-4 py-2 rounded-lg border border-gray-400"
          >
            <div class="flex-grow font-semibold text-tertiary">
              {{ getProductName(itemGroup.controls.productId.value) }}
            </div>

            <div class="w-1/3">
              <app-number-field
                label="Quantidade"
                formControlName="quantity"
                [min]="1"
                [required]="true"
                class="block"
              />
            </div>

            <div class="flex justify-end w-1/4">
              <p-button
                icon="pi pi-times"
                (click)="removeItem($index)"
                styleClass="p-button-rounded p-button-text bg-secondary/10 hover:bg-secondary/20 text-tertiary hover:text-accent"
                title="Remover item"
                type="button"
              />
            </div>
          </div>
        }

        @if (itemsFormArray.length === 0) {
          <div class="p-message p-message-info mt-2">
            <span class="p-message-text">Nenhum item adicionado à nota fiscal ainda.</span>
          </div>
        }
      </div>

      @if (itemsFormArray.invalid && itemsFormArray.touched) {
        <div class="p-error text-sm mt-2 font-medium text-red-600">
          É obrigatório adicionar pelo menos 1 item para salvar a nota.
        </div>
      }

      <div class="flex justify-end gap-2 mt-4 pt-2">
        <p-button
          label="Fechar"
          (click)="closeDialog()"
          styleClass="bg-secondary/20 text-tertiary hover:bg-secondary/50 border-none px-10"
          type="button"
        />
        <p-button
          label="Salvar"
          type="submit"
          styleClass="bg-accent text-secondary hover:bg-secondary hover:text-white border-accent px-10"
          loadingIcon="pi pi-spin"
          [disabled]="invoiceNoteForm.invalid || isSaving"
          [loading]="isSaving"
        />
      </div>
    </form>
  </p-dialog>
}
